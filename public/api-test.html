<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Connectivity Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.5;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .header {
      background-color: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
    }
    .result {
      padding: 12px;
      border-radius: 4px;
      margin-top: 8px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    .warning {
      background-color: #fff3cd;
      color: #856404;
    }
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #0069d9;
    }
    code {
      background-color: #f8f9fa;
      padding: 2px 4px;
      border-radius: 4px;
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 0.9em;
    }
    .diagnostics {
      font-size: 0.9em;
      margin-top: 20px;
    }
    .test-item {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ZehMizeh API Connectivity Test</h1>
    <p>Use this page to test your connection to the API server and diagnose any networking issues.</p>
  </div>

  <div class="card">
    <h2>API Configuration</h2>
    <div id="api-config"></div>
    <div class="test-item">
      <button onclick="testApiConfig()">Test API Configuration</button>
      <div id="config-result" class="result"></div>
    </div>
  </div>

  <div class="card">
    <h2>Network Connectivity</h2>
    <div class="test-item">
      <button onclick="testConnection()">Test Internet Connection</button>
      <div id="connection-result" class="result"></div>
    </div>
  </div>

  <div class="card">
    <h2>API Endpoint Tests</h2>
    <div class="test-item">
      <button onclick="testApiEndpoint('/user/get')">Test User Endpoint</button>
      <div id="user-result" class="result"></div>
    </div>
    <div class="test-item">
      <button onclick="testApiEndpoint('/auth/login', true)">Test Login Endpoint</button>
      <div id="login-result" class="result"></div>
    </div>
  </div>

  <div class="card">
    <h2>System Diagnostics</h2>
    <div id="diagnostics" class="diagnostics"></div>
    <button onclick="collectDiagnostics()">Collect Diagnostics</button>
  </div>

  <script>
    // Get the API URL from environment variables
    const apiUrl = getApiUrl();
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      showApiConfig();
      collectDiagnostics();
    });
    
    function getApiUrl() {
      // Try to get from meta tag first (would be set by Next.js)
      const metaTag = document.querySelector('meta[name="next-public-backend-api"]');
      if (metaTag && metaTag.content) {
        return metaTag.content.replace(/\/$/, '');
      }
      
      // Fallback to hardcoded value for this test page
      return 'https://api.zehmizeh.com';
    }
    
    function showApiConfig() {
      const configDiv = document.getElementById('api-config');
      configDiv.innerHTML = `
        <p>Current API URL: <code>${apiUrl || 'Not configured'}</code></p>
        <p>Browser online: <code>${navigator.onLine ? 'Yes' : 'No'}</code></p>
      `;
    }
    
    async function testApiConfig() {
      const resultDiv = document.getElementById('config-result');
      
      if (!apiUrl) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
          <p><strong>Error:</strong> API URL is not configured.</p>
          <p>Make sure the <code>NEXT_PUBLIC_BACKEND_API</code> environment variable is set correctly.</p>
        `;
        return;
      }
      
      try {
        new URL(apiUrl);
        resultDiv.className = 'result success';
        resultDiv.innerHTML = `<p><strong>Success:</strong> API URL is correctly formatted.</p>`;
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
          <p><strong>Error:</strong> API URL is not a valid URL.</p>
          <p>Current value: <code>${apiUrl}</code></p>
          <p>Error: <code>${error.message}</code></p>
        `;
      }
    }
    
    async function testConnection() {
      const resultDiv = document.getElementById('connection-result');
      
      if (!navigator.onLine) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
          <p><strong>Error:</strong> Browser reports that you are offline.</p>
          <p>Please check your internet connection.</p>
        `;
        return;
      }
      
      try {
        const startTime = performance.now();
        const response = await fetch('https://www.google.com', { 
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-cache',
          timeout: 5000
        });
        const endTime = performance.now();
        
        resultDiv.className = 'result success';
        resultDiv.innerHTML = `
          <p><strong>Success:</strong> Connected to the internet.</p>
          <p>Time: ${Math.round(endTime - startTime)}ms</p>
        `;
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
          <p><strong>Error:</strong> Failed to connect to the internet.</p>
          <p>Error: <code>${error.message}</code></p>
          <p>This suggests you have a network connectivity issue.</p>
        `;
      }
    }
    
    async function testApiEndpoint(endpoint, isPost = false) {
      const resultId = endpoint.replace(/\//g, '-').slice(1) + '-result';
      const resultDiv = document.getElementById(resultId);
      
      if (!apiUrl) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `<p><strong>Error:</strong> API URL is not configured.</p>`;
        return;
      }
      
      try {
        const startTime = performance.now();
        let response;
        
        if (isPost) {
          // For POST endpoint, we'll just test with a minimal payload
          // This won't actually log in but will test if the endpoint is reachable
          response = await fetch(`${apiUrl}${endpoint}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Cache-Control': 'no-cache',
            },
            body: JSON.stringify({ test: true }),
            cache: 'no-cache',
            timeout: 5000
          });
        } else {
          response = await fetch(`${apiUrl}${endpoint}`, {
            method: 'GET',
            headers: {
              'Cache-Control': 'no-cache',
            },
            cache: 'no-cache',
            timeout: 5000
          });
        }
        
        const endTime = performance.now();
        
        // Even if we got an error status, we're testing connectivity, not auth
        resultDiv.className = 'result success';
        resultDiv.innerHTML = `
          <p><strong>Success:</strong> Connected to API endpoint.</p>
          <p>Status: ${response.status}</p>
          <p>Time: ${Math.round(endTime - startTime)}ms</p>
        `;
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
          <p><strong>Error:</strong> Failed to connect to API endpoint.</p>
          <p>Error: <code>${error.message}</code></p>
          <p>URL: <code>${apiUrl}${endpoint}</code></p>
          <p>This suggests either the API server is down or there are network connectivity issues.</p>
        `;
      }
    }
    
    function collectDiagnostics() {
      const diagnosticsDiv = document.getElementById('diagnostics');
      
      const userAgent = navigator.userAgent;
      const language = navigator.language;
      const cookiesEnabled = navigator.cookieEnabled;
      const connectionType = navigator.connection ? navigator.connection.effectiveType : 'unknown';
      const timestamp = new Date().toISOString();
      
      diagnosticsDiv.innerHTML = `
        <p><strong>Browser:</strong> ${userAgent}</p>
        <p><strong>Language:</strong> ${language}</p>
        <p><strong>Cookies Enabled:</strong> ${cookiesEnabled}</p>
        <p><strong>Connection Type:</strong> ${connectionType}</p>
        <p><strong>Timestamp:</strong> ${timestamp}</p>
        <p><strong>Online Status:</strong> ${navigator.onLine ? 'Online' : 'Offline'}</p>
      `;
    }
  </script>
</body>
</html> 